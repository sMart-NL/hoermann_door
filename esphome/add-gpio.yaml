# These substitutions allow the end user to override certain values
substitutions:
  name: "supramatic-e3"
  friendly_name: "SupraMatic E3"
  state: "State"
  opening: "Opening"
  closing: "Closing"
  open: "Open"
  closed: "Closed"
  stopped: "Stopped"
  venting: "Venting"
  error: "Error"
  relay_state: "Relay state"
  got_valid_broadcast: "Valid Status received" 
  error_state: "Error State" 
  prewarn_state: "Prewarn State" 
  light: "${friendly_name} Light"
  sw_vent: "${friendly_name} Venting" 
  sw_light: "Switch Light" 
  btn_vent: "${friendly_name} Vent" 
  btn_impulse: "${friendly_name} Impulse" 

esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"

esp8266:
  board: esp01_1m

esp32:
  board: esp32dev # set your board
  framework:
    type: esp-idf # mandatory for esp version

external_components:
    - source: github://14yannick/hoermann_door
      refresh: 0s

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
  encryption:
    key: !secret api_key_e3_supra
  
ota:
  - platform: esphome
    password: !secret ota_password

logger:
  level: WARN
  baud_rate: 0 # Disable Serial logging to avoid conflict with uart bus on UART0

uart:
  id: uart_bus
  baud_rate: 19200
  rx_pin: 16
  tx_pin: 17

# -------------------------------------------------------------------
# Hoermann Bridge
# -------------------------------------------------------------------
uapbridge_esp:
  id: garage_bridge
  uart_id: uart_bus
  auto_correction: true
  # rts_pin: 4 # this can be set, if needed for the connected hardware
  
# -------------------------------------------------------------------
# Covers
# -------------------------------------------------------------------
cover:
  - platform: template
    name: "${blind_name}"
    id: garage_cover
    device_class: garage
    disabled_by_default: false  # Forceer actief in HA!
    lambda: |-
      auto s = id(garage_bridge).get_state_string();
      if (s == "Open") {
        return COVER_OPEN;
      }
      if (s == "Closed") {
        return COVER_CLOSED;
      }
      return COVER_OPEN;
    open_action:
      - lambda: 'id(garage_bridge).action_open();'
    close_action:
      - lambda: 'id(garage_bridge).action_close();'
    stop_action:
      - lambda: 'id(garage_bridge).action_stop();'


# -------------------------------------------------------------------
# Actieknoppen
# -------------------------------------------------------------------
button:
  - platform: template
    name: "${friendly_name} Open"
    disabled_by_default: false  # Forceer zichtbaar/actief
    on_press:
      - lambda: 'id(garage_bridge).action_open();'

  - platform: template
    name: "${friendly_name} Close"
    disabled_by_default: false  # Forceer zichtbaar/actief
    on_press:
      - lambda: 'id(garage_bridge).action_close();'

  - platform: template
    name: "${friendly_name} Stop"
    disabled_by_default: false  # Forceer zichtbaar/actief
    on_press:
      - lambda: 'id(garage_bridge).action_stop();'

  - platform: template
    name: "${friendly_name} Venting"
    disabled_by_default: false  # Forceer zichtbaar/actief
    on_press:
      - if:
          condition:
            binary_sensor.is_on: garage_venting_status
          then:
            - lambda: 'id(garage_bridge).action_close();'
          else:
            - lambda: 'id(garage_bridge).action_venting();'

  - platform: template
    name: "${btn_impulse}"
    on_press:
      - lambda: 'id(garage_bridge).action_impulse();'

# -------------------------------------------------------------------
# Binary sensors - GPIO for local control
# -------------------------------------------------------------------
binary_sensor:
  - platform: gpio
    pin:
      number: 32
      mode:
        input: true
        pullup: true
      inverted: true
    id: btn_open_local
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(garage_bridge).action_open();'

  - platform: gpio
    pin:
      number: 33
      mode:
        input: true
        pullup: true
      inverted: true
    id: btn_close_local
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(garage_bridge).action_close();'

  - platform: gpio
    pin:
      number: 27
      mode:
        input: true
        pullup: true
      inverted: true
    id: btn_stop_local
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(garage_bridge).action_stop();'

  - platform: gpio
    pin:
      number: 25
      mode:
        input: true
        pullup: true
      inverted: true
    id: btn_vent_local
    internal: true
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      - lambda: 'id(garage_bridge).action_venting();'

  - platform: gpio
    pin:
      number: 26
      mode:
        input: true
        pullup: true
      inverted: true
    id: btn_lamp_local
    internal: true
    filters:
      - delayed_on: 50ms
    on_press:
      - lambda: 'id(garage_bridge).action_toggle_light();'

  - platform: uapbridge
    relay_state:
      name: "${relay_state}"
      id: relay_state
    error_state:
      name: "${error_state}"
      id: error_state
      on_press:
        - output.turn_on: led_error
      on_release:
        - output.turn_off: led_error
    prewarn_state:
      name: "${prewarn_state}"
      id: prewarn_state
    got_valid_broadcast:
      name: "${got_valid_broadcast}"
      id: got_valid_broadcast

  - platform: template
    name: "Garage Opened"
    id: garage_open_status
    lambda: 'return id(garage_bridge).get_state_string() == "Open";'

  - platform: template
    name: "Garage Closed"
    id: garage_closed_status
    lambda: 'return id(garage_bridge).get_state_string() == "Closed";'

  - platform: template
    name: "Garage Moving"
    id: garage_moving_status
    lambda: |-
      auto s = id(garage_bridge).get_state_string();
      return s == "Opening" || s == "Closing";

  - platform: template
    name: "Garage Venting"
    id: garage_venting_status
    lambda: 'return id(garage_bridge).get_state_string() == "Venting";'

# -------------------------------------------------------------------
# Interval (LED OK knipper)
# -------------------------------------------------------------------
interval:
  - interval: 500ms
    then:
      - if:
          condition:
            and:
              - binary_sensor.is_on: got_valid_broadcast
              - binary_sensor.is_off: error_state
          then:
            - output.turn_on: led_ok
            - delay: 100ms
            - output.turn_off: led_ok

# -------------------------------------------------------------------
# Outputs - GPIO
# -------------------------------------------------------------------
output:
  - platform: uapbridge
    id: gd_light

  - platform: gpio
    pin: GPIO22
    id: led_open
    inverted: true

  - platform: gpio
    pin: GPIO23
    id: led_closed
    inverted: true

  - platform: gpio
    pin: GPIO19
    id: led_error
    inverted: true

  - platform: gpio
    pin: GPIO21
    id: led_ok
    inverted: true

# -------------------------------------------------------------------
# Lights
# -------------------------------------------------------------------
light:
  - platform: uapbridge
    id: my_light
    name: "${light}"
    output: gd_light

  - platform: binary
    id: led_open_local
    output: led_open
    disabled_by_default: true

  - platform: binary
    id: led_closed_local
    output: led_closed
    disabled_by_default: true

  - platform: binary
    id: led_error_local
    output: led_error
    disabled_by_default: true

  - platform: binary
    id: led_ok_local
    output: led_ok
    disabled_by_default: true

# -------------------------------------------------------------------
# Text sensor
# -------------------------------------------------------------------
text_sensor:
  - platform: uapbridge
    id: garage_door_state
    name: "${state}"
    on_value:
      - lambda: |-
          auto s = id(garage_door_state).state;
          if (s == "Open") {
            id(led_open).turn_on();
            id(led_closed).turn_off();
          } else if (s == "Closed") {
            id(led_open).turn_off();
            id(led_closed).turn_on();
          }
